<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pixel Art Editor</title>
<style>
  html, body { margin:0; padding:0; height:100%; font-family:Verdana,sans-serif; background:#222; color:#fff; }
  #toolbar { display:flex; gap:4px; padding:4px; background:#333; align-items:center; }
  #toolbar button { padding:4px 8px; background:#444; color:#fff; border:none; cursor:pointer; }
  #toolbar button.active { background:#666; }
  #toolbar input[type=color], #toolbar input[type=range] { margin-left:4px; }
  #canvasContainer { flex:1; position:relative; overflow:auto; background:#111; cursor:crosshair; }
  canvas { display:block; background:#000; image-rendering:pixelated; }
</style>
</head>
<body>
<div id="toolbar">
  <button id="toolPencil" class="active">Pencil</button>
  <button id="toolRect">Rectangle</button>
  <button id="toolFill">Fill</button>
  <button id="toolEraser">Eraser</button>
  <label>Color: <input type="color" id="colorPicker" value="#ff0000"></label>
  <label>Pixel Size: <input type="range" id="pixelSize" min="4" max="32" value="16"></label>
  <button id="undoBtn">Undo</button>
  <button id="redoBtn">Redo</button>
</div>
<div id="canvasContainer">
  <canvas id="pixelCanvas"></canvas>
</div>

<script>
const canvas = document.getElementById('pixelCanvas');
const ctx = canvas.getContext('2d');

let gridWidth = 16;
let gridHeight = 16;
let pixelSize = 16;
let currentTool = 'pencil';
let currentColor = '#ff0000';
let isDrawing = false;
let startX = 0, startY = 0;

// Undo/Redo stack
let undoStack = [], redoStack = [];
function saveState() {
  redoStack = [];
  undoStack.push(ctx.getImageData(0,0,canvas.width,canvas.height));
  if(undoStack.length > 50) undoStack.shift();
}
function undo() { if(undoStack.length){ redoStack.push(ctx.getImageData(0,0,canvas.width,canvas.height)); ctx.putImageData(undoStack.pop(),0,0); }}
function redo() { if(redoStack.length){ undoStack.push(ctx.getImageData(0,0,canvas.width,canvas.height)); ctx.putImageData(redoStack.pop(),0,0); }}

// Initialize canvas
function resizeCanvas() {
  canvas.width = gridWidth * pixelSize;
  canvas.height = gridHeight * pixelSize;
  drawGrid();
}
function drawGrid() {
  ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = '#333';
  for(let x=0;x<=gridWidth;x++){
    ctx.beginPath(); ctx.moveTo(x*pixelSize,0); ctx.lineTo(x*pixelSize,canvas.height); ctx.stroke();
  }
  for(let y=0;y<=gridHeight;y++){
    ctx.beginPath(); ctx.moveTo(0,y*pixelSize); ctx.lineTo(canvas.width,y*pixelSize); ctx.stroke();
  }
}

// Tools
function getMousePos(e){
  const rect = canvas.getBoundingClientRect();
  return {
    x: Math.floor((e.clientX - rect.left)/pixelSize),
    y: Math.floor((e.clientY - rect.top)/pixelSize)
  };
}
function drawPixel(x,y,color){
  ctx.fillStyle = color;
  ctx.fillRect(x*pixelSize, y*pixelSize, pixelSize, pixelSize);
}

function floodFill(x,y,color){
  const img = ctx.getImageData(0,0,canvas.width,canvas.height);
  const w = canvas.width/ pixelSize;
  const h = canvas.height/ pixelSize;
  const targetColor = getPixelColor(img,x,y);
  if(targetColor === color) return;
  const stack = [[x,y]];
  while(stack.length){
    const [cx,cy] = stack.pop();
    if(cx<0||cy<0||cx>=w||cy>=h) continue;
    if(getPixelColor(img,cx,cy)!==targetColor) continue;
    setPixelColor(img,cx,cy,color);
    stack.push([cx+1,cy],[cx-1,cy],[cx,cy+1],[cx,cy-1]);
  }
  ctx.putImageData(img,0,0);
}
function getPixelColor(img,x,y){
  const idx = (y*pixelSize*canvas.width + x*pixelSize)*4;
  return `rgba(${img.data[idx]},${img.data[idx+1]},${img.data[idx+2]},${img.data[idx+3]/255})`;
}
function setPixelColor(img,x,y,color){
  const c = parseColor(color);
  for(let px=0;px<pixelSize;px++){
    for(let py=0;py<pixelSize;py++){
      const idx = ((y*pixelSize+py)*canvas.width + (x*pixelSize+px))*4;
      img.data[idx] = c.r; img.data[idx+1] = c.g; img.data[idx+2] = c.b; img.data[idx+3] = c.a;
    }
  }
}
function parseColor(hex){
  const c = hex.match(/\w\w/g).map(h=>parseInt(h,16));
  return {r:c[0],g:c[1],b:c[2],a:255};
}

// Mouse events
canvas.addEventListener('mousedown', e => {
  const pos = getMousePos(e);
  startX = pos.x; startY = pos.y;
  isDrawing = true;
  saveState();
  if(currentTool==='pencil') drawPixel(pos.x,pos.y,currentColor);
  if(currentTool==='eraser') drawPixel(pos.x,pos.y,'#000000');
  if(currentTool==='fill') floodFill(pos.x,pos.y,currentColor);
});
canvas.addEventListener('mousemove', e => {
  if(!isDrawing) return;
  const pos = getMousePos(e);
  if(currentTool==='pencil') drawPixel(pos.x,pos.y,currentColor);
  if(currentTool==='eraser') drawPixel(pos.x,pos.y,'#000000');
  if(currentTool==='rect'){
    drawRectPreview(startX,startY,pos.x,pos.y);
  }
});
canvas.addEventListener('mouseup', e => {
  if(currentTool==='rect') {
    const pos = getMousePos(e);
    drawRect(startX,startY,pos.x,pos.y,currentColor);
  }
  isDrawing = false;
});

// Rectangle drawing
function drawRect(x1,y1,x2,y2,color){
  const xmin = Math.min(x1,x2), xmax=Math.max(x1,x2);
  const ymin = Math.min(y1,y2), ymax=Math.max(y1,y2);
  for(let x=xmin;x<=xmax;x++) for(let y=ymin;y<=ymax;y++) drawPixel(x,y,color);
}
function drawRectPreview(x1,y1,x2,y2){
  // optional: implement a live preview
}

// Toolbar events
document.getElementById('toolPencil').onclick = ()=>currentTool='pencil';
document.getElementById('toolRect').onclick = ()=>currentTool='rect';
document.getElementById('toolFill').onclick = ()=>currentTool='fill';
document.getElementById('toolEraser').onclick = ()=>currentTool='eraser';
document.getElementById('colorPicker').onchange = e=>currentColor=e.target.value;
document.getElementById('pixelSize').oninput = e=>{ pixelSize=parseInt(e.target.value); resizeCanvas(); drawGrid(); };
document.getElementById('undoBtn').onclick = undo;
document.getElementById('redoBtn').onclick = redo;

// Save/Load functions
function saveProject(){ return canvas.toDataURL(); }
function loadProject(base64){
  const img = new Image();
  img.onload = ()=>{ ctx.drawImage(img,0,0,img.width,img.height,0,0,canvas.width,canvas.height); };
  img.src = base64;
}

// Initialize
resizeCanvas();
drawGrid();
</script>
</body>
</html>
